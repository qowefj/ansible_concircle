---
- name: Force Start Windows 10 Updates
  hosts: windows
  become: yes
  become_method: runas
  become_user: Administrator

  tasks:

    - name: Import PSWindowsUpdate module
      win_shell: |
        powershell.exe -Command "Start-Process PowerShell -ArgumentList 'Import-Module PSWindowsUpdate' -Verb RunAs"
      args:
        executable: cmd

    - name: Force Windows Update to check for updates
      win_shell: |
        powershell.exe -Command "Start-Process PowerShell -ArgumentList '(New-Object -ComObject Microsoft.Update.AutoUpdate).DetectNow()' -Verb RunAs"
      args:
        executable: cmd

    - name: Download and install updates
      win_shell: |
        powershell.exe -Command "Start-Process PowerShell -ArgumentList 'Get-WindowsUpdate -AcceptAll -Install -AutoReboot' -Verb RunAs"
      args:
        executable: cmd

    - name: Reboot if updates are installed and pending a restart
      win_reboot:
        msg: "Rebooting after Windows updates"
        pre_reboot_delay: 60
        post_reboot_delay: 120
        reboot_timeout: 3600
        connect_timeout: 600
        test_command: 'powershell.exe -Command "(Get-WmiObject -Class Win32_ComputerSystem).PartOfDomain"'
