---
- name: Configure Windows Update schedule and initiate updates
  hosts: windows
  gather_facts: no
  tasks:
    - name: Set preferred update time to Saturday 1 PM (CET) using Group Policy
      win_shell: |
        Import-Module UpdateSettings
        $policy = Get-WindowsUpdatePolicy
        $policy.ScheduledInstallDay = 6
        $policy.ScheduledInstallTime = 13
        $policy.ActiveHoursStart = 13
        $policy.ActiveHoursEnd = 14
        Set-WindowsUpdatePolicy -Policy $policy
      args:
        executable: powershell

    - name: Initiate Windows Update scan, download, and install
      win_shell: |
        Install-WindowsUpdate -AcceptAll -AutoReboot
      args:
        executable: powershell
